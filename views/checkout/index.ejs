<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <link rel="stylesheet" href="/checkout.css" />
    <link rel="stylesheet" href="/navbar.css" />
    <link rel="stylesheet" href="/footer.css" />
    <title>Cart</title>
</head>

<body>
    <%- include("../partials/navbar") %>

    <main>
        <div class="items-wrapper">
            <h2>Cart Items</h2>
            <div class="items">
                <!-- Cart items will be rendered here -->
            </div>
        </div>
    </main>

    <%- include("checkout-partials/checkout") %>
    <%- include("../partials/footer") %>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.1.2/axios.min.js"></script>
    <script src="/middleware/checkSession.js"></script>

   <script>
    let cart=null;

    try {
        const cartRaw = localStorage.getItem("cart");
        
        if (cartRaw) {
            const parsed = JSON.parse(cartRaw);
            console.log("Parsed cart data:", parsed);
            if (parsed && Array.isArray(parsed.items)) {
                cart = parsed;
                // Ensure total is a number
                cart.total = typeof parsed.total === 'number' ? parsed.total : 0
                console.log("Cart successfully loaded from localStorage:", cart);
                console.log("Cart total:", cart.total);
            } else {
                console.warn("Invalid cart structure in localStorage. Resetting cart.");
                cart = { items: [], total: 0 };
                }
        } else {
            console.warn("No cart data found in localStorage. Initializing empty cart.");
            cart = { items: [], total: 0 };            
        }
    } catch (err) {
        console.error("Error parsing cart from localStorage:", err);
    }

    const cartItems = cart.items;
    console.log("Cart items to render:", cartItems);

    function renderCartItems() {
        const itemsContainer = document.querySelector(".items");
        itemsContainer.innerHTML = "";

        if (!cartItems || cartItems.length === 0) {
            itemsContainer.innerHTML = "<p>Your cart is empty.</p>";
            return;
        }

        const fragment = document.createDocumentFragment();

        cartItems.forEach(item => {
            const itemElement = document.createElement("div");
            itemElement.className = "item";

            const imgSrc = item.image || "/img/default.jpg";

            itemElement.innerHTML = `
                <img src="${imgSrc}" alt="${item.name}" class="item-image">
                <div class="item-details">
                    <h3>${item.name}</h3>
                    <p>Price: $${Number(item.price).toFixed(2)}</p>
                    <p>Quantity: ${item.quantity}</p>
                </div>
            `;

            fragment.appendChild(itemElement);
        });

        itemsContainer.appendChild(fragment);
    }

    document.addEventListener("DOMContentLoaded", renderCartItems);
</script>


</body>

</html>
